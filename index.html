<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>라이브 쇼핑 시스템</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            min-height: 100vh; 
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center;
        }
        .app-title { font-size: 2.5em; color: #333; margin-bottom: 10px; }
        .app-subtitle { color: #666; font-size: 1.1em; margin-bottom: 20px; }
        .login-form { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            max-width: 400px; 
            margin: 0 auto;
        }
        .tabs { 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        .tab-nav { 
            display: flex; 
            background: #f8f9fa; 
            flex-wrap: wrap;
        }
        .tab-btn { 
            flex: 1; 
            padding: 15px 20px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-weight: 500; 
            color: #666; 
            transition: all 0.3s;
            min-width: 120px;
        }
        .tab-btn.active { background: #007bff; color: white; }
        .tab-content { 
            padding: 30px; 
            min-height: 500px; 
        }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s; 
            margin: 5px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .alert { 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            position: relative;
        }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .grid { 
            display: grid; 
            gap: 20px; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #eee; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-10 { margin-top: 10px; }
        .live-status { 
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 14px;
        }
        .live-on { background: #28a745; color: white; }
        .live-off { background: #dc3545; color: white; }
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1001;
        }
        .sync-online { background: #28a745; color: white; }
        .sync-offline { background: #dc3545; color: white; }
        .firebase-connected { background: #17a2b8; color: white; }
        .super-admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .license-status {
            display: none !important;
            visibility: hidden !important;
        }
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .custom-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .table th { background: #f8f9fa; font-weight: bold; }
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .cart-timer {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .edit-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .edit-controls input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .edit-controls label {
            font-size: 11px;
            margin-bottom: 2px;
            color: #666;
        }
        .edit-field {
            display: flex;
            flex-direction: column;
        }
        .customer-edit-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .customer-edit-field {
            display: flex;
            flex-direction: column;
        }
        .confirmed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .order-filter {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-container {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        .merge-request-field {
            margin-top: 5px;
            display: none;
        }
        .order-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .status-pending { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; }
        .status-paid { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; padding: 4px 8px; border-radius: 4px; }
        .status-shipped { background: #e2e3e5; color: #495057; padding: 4px 8px; border-radius: 4px; }
        .firebase-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .firebase-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .firebase-disconnected { background: #dc3545; color: white; }
        .firebase-connecting { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status sync-offline">오프라인</div>

    <div class="container">
        <!-- 로그인 화면 -->
        <div id="loginScreen" class="header">
            <h1 class="app-title">라이브 쇼핑 시스템</h1>
            <p class="app-subtitle">실시간 주문·재고·고객 통합 관리</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label>모드 선택</label>
                    <select id="userMode">
                        <option value="customer">고객</option>
                        <option value="admin">관리자</option>
                        <option value="superadmin">최고관리자</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="userName" placeholder="이름을 입력하세요">
                </div>
                <div class="form-group" id="phoneGroup">
                    <label>연락처</label>
                    <input type="text" id="userPhone" placeholder="연락처를 입력하세요">
                </div>
                <div class="form-group hidden" id="adminPasswordGroup">
                    <label>관리자 비밀번호</label>
                    <input type="password" id="adminPassword" placeholder="비밀번호를 입력하세요">
                </div>
                <div class="form-group hidden" id="superAdminPasswordGroup">
                    <label>최고관리자 비밀번호</label>
                    <input type="password" id="superAdminPassword" placeholder="최고관리자 비밀번호를 입력하세요">
                </div>
                <button class="btn btn-primary" onclick="login()">로그인</button>
            </div>
        </div>

        <script>
        // 엔터키 로그인 기능
        document.addEventListener('DOMContentLoaded', function() {
            var loginInputs = ['userName', 'userPhone', 'adminPassword', 'superAdminPassword'];
            loginInputs.forEach(function(inputId) {
                var input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                }
            });
        });
        
        // 전체 시스템 엔터키 기능 추가
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                var activeElement = document.activeElement;
                var tagName = activeElement.tagName.toLowerCase();
                
                // 현재 활성화된 모달 확인
                var activeModal = null;
                var modals = ['addItemModal', 'addCustomerModal', 'paymentModal'];
                for (var i = 0; i < modals.length; i++) {
                    var modal = document.getElementById(modals[i]);
                    if (modal && !modal.classList.contains('hidden')) {
                        activeModal = modals[i];
                        break;
                    }
                }
                
                // 모달별 엔터키 처리
                if (activeModal === 'addItemModal') {
                    if (tagName === 'input') {
                        addItem();
                    }
                } else if (activeModal === 'addCustomerModal') {
                    if (tagName === 'input' || tagName === 'textarea') {
                        addCustomer();
                    }
                } else if (activeModal === 'paymentModal') {
                    confirmPayment();
                }
                // 일반 폼 처리
                else if (tagName === 'input') {
                    var inputId = activeElement.id;
                    
                    // Firebase 설정 입력들
                    if (inputId.startsWith('firebase')) {
                        var firebaseInputs = ['firebaseApiKey', 'firebaseAuthDomain', 'firebaseDatabaseURL', 'firebaseProjectId', 'firebaseStorageBucket', 'firebaseMessagingSenderId', 'firebaseAppId'];
                        if (firebaseInputs.indexOf(inputId) !== -1) {
                            connectFirebase();
                        }
                    }
                    // 도메인 추가
                    else if (inputId === 'newDomain') {
                        addDomain();
                    }
                    // 관리자 계정 추가
                    else if (inputId === 'newAdminId' || inputId === 'newAdminPassword' || inputId === 'newAdminName') {
                        addAdminAccount();
                    }
                    // 배송비 설정
                    else if (inputId === 'baseShipping' || inputId === 'freeShippingThreshold') {
                        saveShippingSettings();
                    }
                    // 은행 정보
                    else if (inputId === 'bankName' || inputId === 'accountNumber' || inputId === 'accountHolder') {
                        saveBankInfo();
                    }
                    // 주문 검색
                    else if (inputId === 'orderSearch') {
                        renderOrders();
                    }
                    // 고객 검색
                    else if (inputId === 'customerSearch') {
                        searchCustomers();
                    }
                }
                // 텍스트에리어 처리
                else if (tagName === 'textarea') {
                    var textareaId = activeElement.id;
                    if (textareaId === 'bankNotice') {
                        saveBankInfo();
                    } else if (textareaId === 'shippingAddress' || textareaId === 'customDeliveryRequest') {
                        // 배송 정보는 엔터로 저장하지 않음 (여러 줄 입력 가능)
                        return;
                    }
                }
            }
        });
        </script>

        <!-- 메인 화면 -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <h1 class="app-title">라이브 쇼핑 시스템</h1>
                <div class="flex justify-between align-center">
                    <div>
                        <span id="currentUserInfo"></span>
                        <span id="licenseStatusBadge" class="license-status license-valid">개발자</span>
                        <span id="liveStatus" class="live-status live-off">라이브 종료</span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 최고관리자 화면 -->
            <div id="superAdminPanel" class="tabs hidden">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showSuperAdminTab('firebase', event)">Firebase 연동</button>
                    <button class="tab-btn" onclick="showSuperAdminTab('license', event)">라이센스 관리</button>
                    <button class="tab-btn" onclick="showSuperAdminTab('system', event)">시스템 설정</button>
                </div>

                <!-- Firebase 연동 탭 -->
                <div id="firebase-tab" class="tab-content">
                    <h2>Firebase 실시간 동기화 설정</h2>
                    
                    <div class="firebase-config">
                        <h3>Firebase 연결 상태</h3>
                        <div id="firebaseConnectionStatus" class="alert alert-warning">
                            <p>Firebase가 연결되지 않았습니다. 아래 설정을 입력하여 연결하세요.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Firebase API Key</label>
                            <input type="password" id="firebaseApiKey" placeholder="Firebase API Key를 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>Auth Domain</label>
                            <input type="text" id="firebaseAuthDomain" placeholder="your-project.firebaseapp.com">
                        </div>
                        <div class="form-group">
                            <label>Database URL</label>
                            <input type="text" id="firebaseDatabaseURL" placeholder="https://your-project-default-rtdb.firebaseio.com/">
                        </div>
                        <div class="form-group">
                            <label>Project ID</label>
                            <input type="text" id="firebaseProjectId" placeholder="your-project-id">
                        </div>
                        <div class="form-group">
                            <label>Storage Bucket</label>
                            <input type="text" id="firebaseStorageBucket" placeholder="your-project.appspot.com">
                        </div>
                        <div class="form-group">
                            <label>Messaging Sender ID</label>
                            <input type="text" id="firebaseMessagingSenderId" placeholder="123456789012">
                        </div>
                        <div class="form-group">
                            <label>App ID</label>
                            <input type="text" id="firebaseAppId" placeholder="1:123456789012:web:abcdef123456">
                        </div>
                        
                        <div class="mt-10">
                            <button class="btn btn-primary" onclick="connectFirebase()">Firebase 연결</button>
                            <button class="btn btn-danger" onclick="disconnectFirebase()">연결 해제</button>
                            <button class="btn btn-info" onclick="testFirebaseConnection()">연결 테스트</button>
                        </div>
                    </div>

                    <div class="card mt-10">
                        <h3>동기화 설정</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="syncOrders" checked> 주문 데이터 동기화
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="syncInventory" checked> 재고 데이터 동기화
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="syncCustomers" checked> 고객 데이터 동기화
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="syncLiveStatus" checked> 라이브 상태 동기화
                            </label>
                        </div>
                        <button class="btn btn-success" onclick="saveSyncSettings()">동기화 설정 저장</button>
                    </div>

                    <div class="card mt-10">
                        <h3>동기화 통계</h3>
                        <div id="syncStats">
                            <p>마지막 동기화: <span id="lastSyncTime">없음</span></p>
                            <p>연결된 기기 수: <span id="connectedDevices">0</span></p>
                            <p>오늘 동기화 횟수: <span id="syncCount">0</span></p>
                        </div>
                        <div class="mt-10">
                            <button class="btn btn-warning" onclick="forceSyncAll()">전체 강제 동기화</button>
                            <button class="btn btn-info" onclick="clearSyncData()">동기화 데이터 초기화</button>
                        </div>
                    </div>
                </div>

                <div id="license-tab" class="tab-content hidden">
                    <h2>도메인 라이센스 관리</h2>
                    <div class="alert alert-info">
                        <h4>개발자 모드 활성화</h4>
                        <p>현재 모든 기능을 무제한으로 사용할 수 있습니다.</p>
                    </div>
                    
                    <div class="card mt-10">
                        <h3>등록된 도메인</h3>
                        <div id="domainList"></div>
                        
                        <h4 class="mt-10">새 도메인 추가</h4>
                        <div class="form-group">
                            <label>도메인 URL</label>
                            <input type="text" id="newDomain" placeholder="예: myshop.com">
                        </div>
                        <div class="form-group">
                            <label>라이센스 기간</label>
                            <select id="licenseType">
                                <option value="monthly">월간 (30일)</option>
                                <option value="yearly">연간 (365일)</option>
                                <option value="unlimited">무제한 (개발용)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addDomain()">도메인 추가</button>
                    </div>

                    <div class="card mt-10">
                        <h3>관리자 계정 관리</h3>
                        <div id="adminAccountsList"></div>
                        
                        <h4 class="mt-10">새 관리자 계정 추가</h4>
                        <div class="form-group">
                            <label>관리자 ID</label>
                            <input type="text" id="newAdminId" placeholder="관리자 ID를 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>관리자 비밀번호</label>
                            <input type="password" id="newAdminPassword" placeholder="비밀번호를 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>관리자 이름</label>
                            <input type="text" id="newAdminName" placeholder="관리자 이름을 입력하세요">
                        </div>
                        <button class="btn btn-primary" onclick="addAdminAccount()">관리자 계정 추가</button>
                    </div>
                </div>

                <div id="system-tab" class="tab-content hidden">
                    <h2>시스템 설정</h2>
                    <div class="card">
                        <h3>시스템 상태</h3>
                        <p>모든 시스템이 정상 작동 중입니다.</p>
                    </div>
                </div>
            </div>

            <!-- 관리자 화면 -->
            <div id="adminPanel" class="tabs hidden">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showAdminTab('liveControl', event)">라이브 제어</button>
                    <button class="tab-btn" onclick="showAdminTab('orderManagement', event)">주문 관리</button>
                    <button class="tab-btn" onclick="showAdminTab('inventory', event)">재고 관리</button>
                    <button class="tab-btn" onclick="showAdminTab('shipping', event)">배송비 설정</button>
                    <button class="tab-btn" onclick="showAdminTab('customers', event)">고객 주소록</button>
                    <button class="tab-btn" onclick="showAdminTab('bankInfo', event)">입금 안내</button>
                </div>

                <!-- 라이브 제어 -->
                <div id="liveControl-tab" class="tab-content">
                    <h2>라이브 제어</h2>
                    <div class="mb-20">
                        <button id="liveToggleBtn" class="btn btn-success" onclick="toggleLive()">라이브 시작</button>
                        <p class="mt-10">라이브 상태에 따라 고객의 주문 가능 여부가 결정됩니다.</p>
                    </div>
                    <div class="alert alert-info">
                        <h4>현재 상태</h4>
                        <p id="liveStatusInfo">라이브가 종료되어 있습니다. 고객은 주문할 수 없습니다.</p>
                    </div>
                </div>

                <!-- 주문 관리 -->
                <div id="orderManagement-tab" class="tab-content hidden">
                    <h2>주문 관리</h2>
                    
                    <div class="order-filter">
                        <div class="filter-row">
                            <label>날짜 필터:</label>
                            <input type="date" id="startDate">
                            <span>~</span>
                            <input type="date" id="endDate">
                            <label>고객별:</label>
                            <select id="customerFilter">
                                <option value="">전체 고객</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <label>상태:</label>
                            <select id="statusFilter">
                                <option value="">전체 상태</option>
                                <option value="입금대기">입금대기</option>
                                <option value="입금완료">입금완료</option>
                                <option value="주문확정">주문확정</option>
                                <option value="출고완료">출고완료</option>
                            </select>
                            <input type="text" id="orderSearch" placeholder="주문번호, 상품명 검색">
                            <button class="btn btn-info" onclick="renderOrders()">검색</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between align-center mb-20">
                        <div>
                            <label>그룹 보기:</label>
                            <select id="orderGroupBy" onchange="renderOrders()">
                                <option value="all">전체</option>
                                <option value="customer">고객별</option>
                                <option value="item">상품별</option>
                                <option value="status">상태별</option>
                                <option value="date">날짜별</option>
                            </select>
                        </div>
                        <div class="order-actions">
                            <button class="btn btn-success" onclick="exportToExcel()">엑셀 내보내기</button>
                            <button class="btn btn-warning" onclick="deleteSelectedOrders()">선택 삭제</button>
                            <button class="btn btn-danger" onclick="clearAllOrders()">전체 삭제</button>
                        </div>
                    </div>
                    <div id="ordersContainer"></div>
                </div>

                <!-- 재고 관리 -->
                <div id="inventory-tab" class="tab-content hidden">
                    <h2>재고 관리</h2>
                    <div class="mb-20">
                        <button class="btn btn-primary" onclick="showAddItemModal()">상품 추가</button>
                    </div>
                    <div id="inventoryGrid" class="grid"></div>
                </div>

                <!-- 배송비 설정 -->
                <div id="shipping-tab" class="tab-content hidden">
                    <h2>배송비 설정</h2>
                    <div class="card">
                        <div class="form-group">
                            <label>기본 배송비 (원)</label>
                            <input type="number" id="baseShipping" value="3000">
                        </div>
                        <div class="form-group">
                            <label>무료배송 기준금액 (원)</label>
                            <input type="number" id="freeShippingThreshold" value="50000">
                        </div>
                        <button class="btn btn-primary" onclick="saveShippingSettings()">저장</button>
                    </div>
                </div>

                <!-- 고객 주소록 -->
                <div id="customers-tab" class="tab-content hidden">
                    <h2>고객 주소록</h2>
                    <div class="mb-20">
                        <button class="btn btn-primary" onclick="showAddCustomerModal()">고객 추가</button>
                        <div class="search-container">
                            <label>고객 검색</label>
                            <input type="text" id="customerSearch" class="search-input" placeholder="이름, 닉네임, 연락처로 검색" oninput="searchCustomers()">
                        </div>
                    </div>
                    <div id="customersGrid" class="grid"></div>
                </div>

                <!-- 입금 안내 -->
                <div id="bankInfo-tab" class="tab-content hidden">
                    <h2>입금 계좌 안내</h2>
                    <div class="card">
                        <div class="form-group">
                            <label>은행명</label>
                            <input type="text" id="bankName" value="국민은행">
                        </div>
                        <div class="form-group">
                            <label>계좌번호</label>
                            <input type="text" id="accountNumber" value="123-456-789012">
                        </div>
                        <div class="form-group">
                            <label>예금주</label>
                            <input type="text" id="accountHolder" value="쇼핑몰">
                        </div>
                        <div class="form-group">
                            <label>입금 안내사항</label>
                            <textarea id="bankNotice" rows="4">입금자명은 주문시 입력한 이름과 동일하게 해주세요.
입금 후 '입금완료' 버튼을 클릭해주세요.
입금확인까지 1-2시간 소요될 수 있습니다.</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveBankInfo()">저장</button>
                    </div>
                </div>
            </div>

            <!-- 고객 화면 -->
            <div id="customerPanel" class="tabs hidden">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showCustomerTab('order', event)">주문하기</button>
                    <button class="tab-btn" onclick="showCustomerTab('cart', event)">장바구니</button>
                    <button class="tab-btn" onclick="showCustomerTab('confirmed', event)">구매 확정</button>
                    <button class="tab-btn" onclick="showCustomerTab('myOrders', event)">내 주문</button>
                </div>

                <!-- 주문하기 -->
                <div id="order-tab" class="tab-content">
                    <h2>주문하기</h2>
                    <div id="liveStatusCustomer" class="alert alert-warning">
                        <p>라이브가 종료되어 주문할 수 없습니다.</p>
                    </div>
                    <div id="productsGrid" class="grid"></div>
                </div>

                <!-- 장바구니 -->
                <div id="cart-tab" class="tab-content hidden">
                    <h2>장바구니</h2>
                    <div id="cartTimer" class="cart-timer hidden">
                        장바구니 유지 시간: <span id="timerDisplay"></span>
                    </div>
                    <div id="cartItems"></div>
                    <div id="cartSummary" class="card mt-10 hidden">
                        <h4>주문 요약</h4>
                        <p>상품 금액: <span id="totalAmount">0</span>원</p>
                        <p>배송비: <span id="shippingFee">0</span>원</p>
                        <h3>총 결제금액: <span id="finalAmount">0</span>원</h3>
                        <button class="btn btn-primary mt-10" onclick="confirmPurchase()">구매 확정</button>
                    </div>
                </div>

                <!-- 구매 확정 -->
                <div id="confirmed-tab" class="tab-content hidden">
                    <h2>구매 확정</h2>
                    <div class="alert alert-info">
                        <p>라이브 종료 전까지 주문 내용을 수정할 수 있습니다.</p>
                    </div>
                    <div id="confirmedItems"></div>
                    <div class="card mt-10">
                        <h4>주문 상품 수정</h4>
                        <div id="confirmedItemsList"></div>
                        <div class="mt-10">
                            <button class="btn btn-warning" onclick="returnToCart()">전체 장바구니로 되돌리기</button>
                        </div>
                    </div>
                    <div class="card mt-10">
                        <h4>배송 정보</h4>
                        <div class="form-group">
                            <label>받는 분 이름</label>
                            <input type="text" id="receiverName" placeholder="받는 분 이름을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>연락처</label>
                            <input type="text" id="receiverPhone" placeholder="연락처를 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>배송 주소</label>
                            <textarea id="shippingAddress" rows="3" placeholder="배송받을 주소를 입력하세요"></textarea>
                        </div>
                        <div class="form-group">
                            <label>배송 요청사항</label>
                            <select id="deliveryRequest" onchange="toggleMergeField()">
                                <option value="">선택하세요</option>
                                <option value="합배포망">합배포망</option>
                                <option value="부재시 문앞 배치">부재시 문앞 배치</option>
                                <option value="경비실 보관">경비실 보관</option>
                                <option value="택배함 보관">택배함 보관</option>
                                <option value="직접 수령">직접 수령</option>
                                <option value="기타">기타</option>
                            </select>
                            <input type="text" id="mergePartnerName" class="merge-request-field" placeholder="합배 상대방 이름을 입력하세요" style="margin-top: 10px;">
                            <textarea id="customDeliveryRequest" rows="2" placeholder="기타 요청사항을 입력하세요" style="margin-top: 5px; display: none;"></textarea>
                        </div>
                        <div id="confirmedSummary" class="mt-10">
                            <h4>결제 정보</h4>
                            <p>상품 금액: <span id="confirmedTotalAmount">0</span>원</p>
                            <p>배송비: <span id="confirmedShippingFee">0</span>원</p>
                            <h3>총 결제금액: <span id="confirmedFinalAmount">0</span>원</h3>
                        </div>
                        <div class="flex justify-between mt-10">
                            <button class="btn btn-primary" onclick="proceedToPayment()">구매하기</button>
                        </div>
                    </div>
                </div>

                <!-- 내 주문 -->
                <div id="myOrders-tab" class="tab-content hidden">
                    <h2>내 주문</h2>
                    <div id="customerOrdersContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달들 -->
    <div id="addItemModal" class="modal hidden">
        <div class="modal-content">
            <h3>상품 추가</h3>
            <div class="form-group">
                <label>품명</label>
                <input type="text" id="itemName">
            </div>
            <div class="form-group">
                <label>컬러</label>
                <input type="text" id="itemColor">
            </div>
            <div class="form-group">
                <label>사이즈</label>
                <input type="text" id="itemSize">
            </div>
            <div class="form-group">
                <label>원가 (원)</label>
                <input type="number" id="itemCost">
            </div>
            <div class="form-group">
                <label>판매가 (원)</label>
                <input type="number" id="itemPrice">
            </div>
            <div class="form-group">
                <label>재고 수량</label>
                <input type="number" id="itemStock">
            </div>
            <div class="flex justify-between">
                <button class="btn btn-success" onclick="addItem()">추가</button>
                <button class="btn btn-danger" onclick="closeModal('addItemModal')">취소</button>
            </div>
        </div>
    </div>

    <div id="addCustomerModal" class="modal hidden">
        <div class="modal-content">
            <h3>고객 추가</h3>
            <div class="form-group">
                <label>이름</label>
                <input type="text" id="customerName">
            </div>
            <div class="form-group">
                <label>닉네임</label>
                <input type="text" id="customerNickname">
            </div>
            <div class="form-group">
                <label>연락처</label>
                <input type="text" id="customerPhone">
            </div>
            <div class="form-group">
                <label>주소</label>
                <textarea id="customerAddress" rows="3"></textarea>
            </div>
            <div class="flex justify-between">
                <button class="btn btn-success" onclick="addCustomer()">추가</button>
                <button class="btn btn-danger" onclick="closeModal('addCustomerModal')">취소</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
            <h3>결제 안내</h3>
            <div id="paymentInfo"></div>
            <div class="flex justify-between mt-10">
                <button class="btn btn-success" onclick="confirmPayment()">입금완료</button>
                <button class="btn btn-danger" onclick="closeModal('paymentModal')">취소</button>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// 전역 변수와 함수들
var currentUser = null, isLive = false, cart = [], orders = [], confirmedOrder = null, cartTimer = null, selectedOrders = [];
var firebaseApp = null, firebaseDB = null, isFirebaseConnected = false;
var syncSettings = {orders: true, inventory: true, customers: true, liveStatus: true};
var firebaseConfig = null;
var lastSyncTime = null, connectedDevices = 0, syncCount = 0;

var inventory = [
    {id: 1, name: '티셔츠', color: '화이트', size: 'M', cost: 8000, price: 15000, stock: 50},
    {id: 2, name: '티셔츠', color: '블랙', size: 'L', cost: 8000, price: 15000, stock: 30}
];

var customers = [
    {id: 1, name: '김수민', nickname: '수민님', phone: '010-1234-5678', address: '서울시 강남구'},
    {id: 2, name: '이영희', nickname: '영희님', phone: '010-9876-5432', address: '서울시 서초구'}
];

var adminAccounts = [{id: 'admin', password: 'admin123', name: '기본관리자', createdDate: new Date()}];
var registeredDomains = [{domain: 'localhost', type: 'unlimited', expiry: null, status: 'active'}];
var shippingSettings = {baseShipping: 3000, freeThreshold: 50000};
var bankInfo = {bankName: '국민은행', accountNumber: '123-456-789012', accountHolder: '쇼핑몰', notice: '입금자명은 주문시 입력한 이름과 동일하게 해주세요.\n입금 후 입금완료 버튼을 클릭해주세요.'};

// Firebase 관련 함수들
function connectFirebase() {
    var apiKey = document.getElementById('firebaseApiKey').value.trim();
    var authDomain = document.getElementById('firebaseAuthDomain').value.trim();
    var databaseURL = document.getElementById('firebaseDatabaseURL').value.trim();
    var projectId = document.getElementById('firebaseProjectId').value.trim();
    var storageBucket = document.getElementById('firebaseStorageBucket').value.trim();
    var messagingSenderId = document.getElementById('firebaseMessagingSenderId').value.trim();
    var appId = document.getElementById('firebaseAppId').value.trim();

    if (!apiKey || !authDomain || !databaseURL || !projectId) {
        safeAlert('필수 Firebase 설정 정보를 모두 입력해주세요.');
        return;
    }

    firebaseConfig = {
        apiKey: apiKey,
        authDomain: authDomain,
        databaseURL: databaseURL,
        projectId: projectId,
        storageBucket: storageBucket,
        messagingSenderId: messagingSenderId,
        appId: appId
    };

    try {
        updateFirebaseStatus('connecting');
        
        if (firebaseApp) {
            firebaseApp.delete();
        }

        firebaseApp = firebase.initializeApp(firebaseConfig, 'liveShoppingApp');
        firebaseDB = firebaseApp.database();
        
        // 연결 테스트
        firebaseDB.ref('.info/connected').on('value', function(snapshot) {
            if (snapshot.val() === true) {
                isFirebaseConnected = true;
                updateFirebaseStatus('connected');
                updateSyncStatus('online');
                setupFirebaseListeners();
                syncDataToFirebase();
                safeAlert('Firebase에 성공적으로 연결되었습니다!');
            } else {
                isFirebaseConnected = false;
                updateFirebaseStatus('disconnected');
                updateSyncStatus('offline');
            }
        });

        // Firebase 설정 저장
        saveFirebaseConfig();

    } catch (error) {
        console.error('Firebase 연결 오류:', error);
        updateFirebaseStatus('disconnected');
        safeAlert('Firebase 연결에 실패했습니다: ' + error.message);
    }
}

function disconnectFirebase() {
    if (firebaseApp) {
        firebaseApp.delete();
        firebaseApp = null;
        firebaseDB = null;
        isFirebaseConnected = false;
        updateFirebaseStatus('disconnected');
        updateSyncStatus('offline');
        clearFirebaseConfig();
        safeAlert('Firebase 연결이 해제되었습니다.');
    }
}

function testFirebaseConnection() {
    if (!isFirebaseConnected || !firebaseDB) {
        safeAlert('Firebase가 연결되지 않았습니다.');
        return;
    }

    firebaseDB.ref('test').set({
        timestamp: Date.now(),
        message: 'Firebase 연결 테스트 성공'
    }).then(function() {
        safeAlert('Firebase 연결 테스트 성공!');
        firebaseDB.ref('test').remove();
    }).catch(function(error) {
        safeAlert('Firebase 연결 테스트 실패: ' + error.message);
    });
}

function setupFirebaseListeners() {
    if (!firebaseDB) return;

    // 라이브 상태 동기화
    if (syncSettings.liveStatus) {
        firebaseDB.ref('liveStatus').on('value', function(snapshot) {
            if (snapshot.exists() && snapshot.val() !== isLive) {
                isLive = snapshot.val();
                updateLiveStatus();
            }
        });
    }

    // 주문 동기화
    if (syncSettings.orders) {
        firebaseDB.ref('orders').on('value', function(snapshot) {
            if (snapshot.exists()) {
                var firebaseOrders = snapshot.val();
                if (Array.isArray(firebaseOrders)) {
                    orders = firebaseOrders.map(function(order) {
                        if (order && order.orderDate) {
                            order.orderDate = new Date(order.orderDate);
                        }
                        if (order && order.shippingDate) {
                            order.shippingDate = new Date(order.shippingDate);
                        }
                        return order;
                    });
                    if (currentUser && currentUser.mode === 'admin') {
                        renderOrders();
                    }
                    if (currentUser && currentUser.mode === 'customer') {
                        renderCustomerOrders();
                    }
                }
            }
        });
    }

    // 재고 동기화
    if (syncSettings.inventory) {
        firebaseDB.ref('inventory').on('value', function(snapshot) {
            if (snapshot.exists()) {
                inventory = snapshot.val();
                if (currentUser && currentUser.mode === 'admin') {
                    renderInventory();
                }
                if (currentUser && currentUser.mode === 'customer') {
                    renderProducts();
                }
            }
        });
    }

    // 고객 동기화
    if (syncSettings.customers) {
        firebaseDB.ref('customers').on('value', function(snapshot) {
            if (snapshot.exists()) {
                customers = snapshot.val();
                if (currentUser && currentUser.mode === 'admin') {
                    renderCustomers();
                }
            }
        });
    }

    // 연결된 기기 수 추적
    var connectionsRef = firebaseDB.ref('connections');
    var myConnectionRef = connectionsRef.push();
    
    myConnectionRef.onDisconnect().remove();
    myConnectionRef.set(true);
    
    connectionsRef.on('value', function(snapshot) {
        connectedDevices = snapshot.numChildren();
        updateSyncStats();
    });

    lastSyncTime = new Date();
    updateSyncStats();
}

function syncDataToFirebase() {
    if (!isFirebaseConnected || !firebaseDB) return;

    try {
        var updates = {};
        
        if (syncSettings.liveStatus) {
            updates['liveStatus'] = isLive;
        }
        
        if (syncSettings.orders) {
            updates['orders'] = orders;
        }
        
        if (syncSettings.inventory) {
            updates['inventory'] = inventory;
        }
        
        if (syncSettings.customers) {
            updates['customers'] = customers;
        }

        updates['settings/shipping'] = shippingSettings;
        updates['settings/bank'] = bankInfo;
        updates['lastSync'] = Date.now();

        firebaseDB.ref().update(updates).then(function() {
            lastSyncTime = new Date();
            syncCount++;
            updateSyncStats();
        }).catch(function(error) {
            console.error('Firebase 동기화 오류:', error);
        });

    } catch (error) {
        console.error('데이터 동기화 오류:', error);
    }
}

function forceSyncAll() {
    if (!isFirebaseConnected) {
        safeAlert('Firebase가 연결되지 않았습니다.');
        return;
    }
    
    syncDataToFirebase();
    safeAlert('전체 데이터 동기화가 완료되었습니다.');
}

function clearSyncData() {
    safeConfirm('모든 Firebase 동기화 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.', function(confirmed) {
        if (confirmed && isFirebaseConnected && firebaseDB) {
            firebaseDB.ref().remove().then(function() {
                safeAlert('동기화 데이터가 모두 삭제되었습니다.');
                syncCount = 0;
                lastSyncTime = null;
                updateSyncStats();
            }).catch(function(error) {
                safeAlert('데이터 삭제 실패: ' + error.message);
            });
        }
    });
}

function saveSyncSettings() {
    syncSettings.orders = document.getElementById('syncOrders').checked;
    syncSettings.inventory = document.getElementById('syncInventory').checked;
    syncSettings.customers = document.getElementById('syncCustomers').checked;
    syncSettings.liveStatus = document.getElementById('syncLiveStatus').checked;
    
    saveData();
    
    if (isFirebaseConnected) {
        setupFirebaseListeners();
        syncDataToFirebase();
    }
    
    safeAlert('동기화 설정이 저장되었습니다.');
}

function updateFirebaseStatus(status) {
    var connectionStatus = document.getElementById('firebaseConnectionStatus');
    
    if (connectionStatus) {
        if (status === 'connected') {
            connectionStatus.className = 'alert alert-success';
            connectionStatus.innerHTML = '<p>Firebase가 성공적으로 연결되어 실시간 동기화가 활성화되었습니다.</p>';
        } else if (status === 'connecting') {
            connectionStatus.className = 'alert alert-warning';
            connectionStatus.innerHTML = '<p>Firebase에 연결 중입니다...</p>';
        } else {
            connectionStatus.className = 'alert alert-warning';
            connectionStatus.innerHTML = '<p>Firebase가 연결되지 않았습니다. 아래 설정을 입력하여 연결하세요.</p>';
        }
    }
}

function updateSyncStatus(status) {
    var syncStatus = document.getElementById('syncStatus');
    if (syncStatus) {
        if (status === 'online' && isFirebaseConnected) {
            syncStatus.className = 'sync-status firebase-connected';
            syncStatus.textContent = 'Firebase 동기화';
        } else {
            syncStatus.className = 'sync-status sync-offline';
            syncStatus.textContent = '오프라인';
        }
    }
}

function updateSyncStats() {
    var lastSyncEl = document.getElementById('lastSyncTime');
    var connectedDevicesEl = document.getElementById('connectedDevices');
    var syncCountEl = document.getElementById('syncCount');
    
    if (lastSyncEl) {
        lastSyncEl.textContent = lastSyncTime ? lastSyncTime.toLocaleString() : '없음';
    }
    
    if (connectedDevicesEl) {
        connectedDevicesEl.textContent = connectedDevices;
    }
    
    if (syncCountEl) {
        syncCountEl.textContent = syncCount;
    }
}

function saveFirebaseConfig() {
    if (firebaseConfig) {
        try {
            var configData = {
                apiKey: firebaseConfig.apiKey,
                authDomain: firebaseConfig.authDomain,
                databaseURL: firebaseConfig.databaseURL,
                projectId: firebaseConfig.projectId,
                storageBucket: firebaseConfig.storageBucket,
                messagingSenderId: firebaseConfig.messagingSenderId,
                appId: firebaseConfig.appId
            };
            window.firebaseConfigData = configData;
        } catch (error) {
            console.error('Firebase 설정 저장 오류:', error);
        }
    }
}

function loadFirebaseConfig() {
    try {
        var configData = window.firebaseConfigData;
        if (configData) {
            document.getElementById('firebaseApiKey').value = configData.apiKey || '';
            document.getElementById('firebaseAuthDomain').value = configData.authDomain || '';
            document.getElementById('firebaseDatabaseURL').value = configData.databaseURL || '';
            document.getElementById('firebaseProjectId').value = configData.projectId || '';
            document.getElementById('firebaseStorageBucket').value = configData.storageBucket || '';
            document.getElementById('firebaseMessagingSenderId').value = configData.messagingSenderId || '';
            document.getElementById('firebaseAppId').value = configData.appId || '';
            
            firebaseConfig = configData;
            
            // 자동 연결 시도
            setTimeout(function() {
                if (configData.apiKey && configData.databaseURL) {
                    connectFirebase();
                }
            }, 1000);
        }
    } catch (error) {
        console.error('Firebase 설정 로드 오류:', error);
    }
}

function clearFirebaseConfig() {
    try {
        window.firebaseConfigData = null;
        firebaseConfig = null;
        
        var fields = ['firebaseApiKey', 'firebaseAuthDomain', 'firebaseDatabaseURL', 'firebaseProjectId', 'firebaseStorageBucket', 'firebaseMessagingSenderId', 'firebaseAppId'];
        fields.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = '';
        });
    } catch (error) {
        console.error('Firebase 설정 초기화 오류:', error);
    }
}

// 커스텀 모달 시스템
function safeAlert(message) {
    var alertDiv = document.createElement('div');
    alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; max-width: 300px;';
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    setTimeout(function() { if (alertDiv.parentNode) alertDiv.remove(); }, 3000);
}

function safeConfirm(message, callback) {
    var modal = document.createElement('div');
    modal.className = 'custom-modal';
    var content = document.createElement('div');
    content.className = 'custom-modal-content';
    content.innerHTML = '<p style="margin-bottom: 20px;">' + message + '</p><button id="confirmYes" style="margin: 5px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">확인</button><button id="confirmNo" style="margin: 5px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">취소</button>';
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    content.querySelector('#confirmYes').onclick = function() { document.body.removeChild(modal); callback(true); };
    content.querySelector('#confirmNo').onclick = function() { document.body.removeChild(modal); callback(false); };
}

function safePrompt(message, defaultValue, callback) {
    var modal = document.createElement('div');
    modal.className = 'custom-modal';
    var content = document.createElement('div');
    content.className = 'custom-modal-content';
    content.innerHTML = '<p style="margin-bottom: 15px;">' + message + '</p><input type="text" id="promptInput" value="' + (defaultValue || '') + '" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;"><div style="text-align: center;"><button id="promptOk" style="margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">확인</button><button id="promptCancel" style="margin: 5px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">취소</button></div>';
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    var input = content.querySelector('#promptInput');
    input.focus();
    input.select();
    
    content.querySelector('#promptOk').onclick = function() { var value = input.value; document.body.removeChild(modal); callback(value); };
    content.querySelector('#promptCancel').onclick = function() { document.body.removeChild(modal); callback(null); };
    input.addEventListener('keypress', function(e) { if (e.key === 'Enter') content.querySelector('#promptOk').click(); });
}

// 데이터 저장/로드 (Firebase 연동)
function saveData() {
    try {
        window.liveShoppingData = {
            orders, inventory, customers, shippingSettings, bankInfo, isLive, 
            registeredDomains, adminAccounts, syncSettings,
            lastUpdated: new Date().toISOString()
        };
        
        // Firebase 동기화
        if (isFirebaseConnected) {
            syncDataToFirebase();
        }
    } catch (error) { 
        console.error('저장 실패:', error); 
    }
}

function loadData() {
    try {
        var data = window.liveShoppingData;
        if (data) {
            if (data.orders) orders = data.orders.map(function(order) { if (order.orderDate) order.orderDate = new Date(order.orderDate); if (order.shippingDate) order.shippingDate = new Date(order.shippingDate); return order; });
            if (data.inventory) inventory = data.inventory;
            if (data.customers) customers = data.customers;
            if (data.shippingSettings) shippingSettings = data.shippingSettings;
            if (data.bankInfo) bankInfo = data.bankInfo;
            if (typeof data.isLive === 'boolean') isLive = data.isLive;
            if (data.registeredDomains) registeredDomains = data.registeredDomains;
            if (data.adminAccounts) adminAccounts = data.adminAccounts;
            if (data.syncSettings) syncSettings = data.syncSettings;
        }
    } catch (error) { 
        console.error('로드 실패:', error); 
    }
}

// 로그인
function login() {
    var mode = document.getElementById('userMode').value;
    var name = document.getElementById('userName').value.trim();
    var phone = document.getElementById('userPhone').value.trim();
    
    if (!name) { safeAlert('이름을 입력해주세요.'); return; }

    if (mode === 'superadmin') {
        if (document.getElementById('superAdminPassword').value !== 'lulu0813') { safeAlert('최고관리자 비밀번호가 올바르지 않습니다.'); return; }
        currentUser = {name: name, mode: 'superadmin'};
        showSuperAdminPanel();
    } else if (mode === 'admin') {
        var password = document.getElementById('adminPassword').value;
        var validAdmin = adminAccounts.find(function(admin) { return admin.password === password; });
        if (!validAdmin && password !== 'admin123') { safeAlert('관리자 비밀번호가 올바르지 않습니다.'); return; }
        currentUser = {name: name, mode: 'admin', adminId: validAdmin ? validAdmin.id : 'admin'};
        showAdminPanel();
    } else {
        if (!phone) { safeAlert('연락처를 입력해주세요.'); return; }
        currentUser = {name: name, phone: phone, mode: 'customer'};
        showCustomerPanel();
    }

    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    
    var userInfo = currentUser.name + ' (' + (currentUser.mode === 'superadmin' ? '최고관리자' : currentUser.mode === 'admin' ? '관리자' : '고객') + ')';
    if (currentUser.mode === 'superadmin') userInfo += '<span class="super-admin-badge">SUPER</span>';
    document.getElementById('currentUserInfo').innerHTML = userInfo;
    
    updateLiveStatus();
}

function logout() {
    currentUser = null; cart = []; confirmedOrder = null; clearTimeout(cartTimer);
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('userName').value = ''; document.getElementById('userPhone').value = '';
    document.getElementById('adminPassword').value = ''; document.getElementById('superAdminPassword').value = '';
}

// 모드 전환
document.getElementById('userMode').addEventListener('change', function() {
    var adminGroup = document.getElementById('adminPasswordGroup');
    var superAdminGroup = document.getElementById('superAdminPasswordGroup');
    var phoneGroup = document.getElementById('phoneGroup');
    
    adminGroup.classList.add('hidden'); superAdminGroup.classList.add('hidden'); phoneGroup.classList.add('hidden');
    
    if (this.value === 'admin') adminGroup.classList.remove('hidden');
    else if (this.value === 'superadmin') superAdminGroup.classList.remove('hidden');
    else phoneGroup.classList.remove('hidden');
});

// 패널 표시
function showSuperAdminPanel() {
    document.getElementById('superAdminPanel').classList.remove('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('customerPanel').classList.add('hidden');
    renderDomainList(); renderAdminAccountsList();
    loadFirebaseConfig();
}

function showAdminPanel() {
    document.getElementById('adminPanel').classList.remove('hidden');
    document.getElementById('superAdminPanel').classList.add('hidden');
    document.getElementById('customerPanel').classList.add('hidden');
    renderOrders(); renderInventory(); renderCustomers(); updateCustomerFilter();
}

function showCustomerPanel() {
    document.getElementById('customerPanel').classList.remove('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('superAdminPanel').classList.add('hidden');
    renderProducts(); renderCart(); renderConfirmedOrder(); renderCustomerOrders();
}

// 탭 전환
function showSuperAdminTab(tabName, event) {
    var tabs = document.querySelectorAll('#superAdminPanel .tab-content');
    var btns = document.querySelectorAll('#superAdminPanel .tab-btn');
    for (var i = 0; i < tabs.length; i++) tabs[i].classList.add('hidden');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    if (event && event.target) event.target.classList.add('active');
    
    if (tabName === 'firebase') {
        loadFirebaseConfig();
        updateSyncStats();
    }
}

function showAdminTab(tabName, event) {
    var tabs = document.querySelectorAll('#adminPanel .tab-content');
    var btns = document.querySelectorAll('#adminPanel .tab-btn');
    for (var i = 0; i < tabs.length; i++) tabs[i].classList.add('hidden');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    if (event && event.target) event.target.classList.add('active');
    if (tabName === 'orderManagement') renderOrders();
    if (tabName === 'inventory') renderInventory();
    if (tabName === 'customers') renderCustomers();
}

function showCustomerTab(tabName, event) {
    var tabs = document.querySelectorAll('#customerPanel .tab-content');
    var btns = document.querySelectorAll('#customerPanel .tab-btn');
    for (var i = 0; i < tabs.length; i++) tabs[i].classList.add('hidden');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    if (event && event.target) event.target.classList.add('active');
    if (tabName === 'order') renderProducts();
    if (tabName === 'cart') renderCart();
    if (tabName === 'confirmed') renderConfirmedOrder();
    if (tabName === 'myOrders') renderCustomerOrders();
}

// 라이브 제어
function toggleLive() { 
    isLive = !isLive; 
    saveData(); 
    updateLiveStatus(); 
    
    // Firebase 동기화
    if (isFirebaseConnected && syncSettings.liveStatus && firebaseDB) {
        firebaseDB.ref('liveStatus').set(isLive);
    }
}

function updateLiveStatus() {
    var statusElement = document.getElementById('liveStatus');
    var toggleBtn = document.getElementById('liveToggleBtn');
    var statusInfo = document.getElementById('liveStatusInfo');
    var customerStatus = document.getElementById('liveStatusCustomer');

    if (isLive) {
        if (statusElement) { statusElement.className = 'live-status live-on'; statusElement.textContent = '라이브 중'; }
        if (toggleBtn) { toggleBtn.textContent = '라이브 종료'; toggleBtn.className = 'btn btn-danger'; }
        if (statusInfo) statusInfo.textContent = '라이브가 진행 중입니다. 고객이 주문할 수 있습니다.';
        if (customerStatus) { customerStatus.className = 'alert alert-success'; customerStatus.innerHTML = '<p>라이브 진행 중! 지금 주문하세요.</p>'; }
    } else {
        if (statusElement) { statusElement.className = 'live-status live-off'; statusElement.textContent = '라이브 종료'; }
        if (toggleBtn) { toggleBtn.textContent = '라이브 시작'; toggleBtn.className = 'btn btn-success'; }
        if (statusInfo) statusInfo.textContent = '라이브가 종료되어 있습니다. 고객은 주문할 수 없습니다.';
        if (customerStatus) { customerStatus.className = 'alert alert-warning'; customerStatus.innerHTML = '<p>라이브가 종료되어 주문할 수 없습니다.</p>'; }
    }
}

// 도메인 관리
function addDomain() {
    var domain = document.getElementById('newDomain').value.trim();
    var licenseType = document.getElementById('licenseType').value;
    if (!domain) { safeAlert('도메인을 입력해주세요.'); return; }
    if (registeredDomains.find(function(d) { return d.domain === domain; })) { safeAlert('이미 등록된 도메인입니다.'); return; }
    
    var expiry = null;
    if (licenseType === 'monthly') { expiry = new Date(); expiry.setDate(expiry.getDate() + 30); }
    else if (licenseType === 'yearly') { expiry = new Date(); expiry.setFullYear(expiry.getFullYear() + 1); }
    
    registeredDomains.push({domain: domain, type: licenseType, expiry: expiry, status: 'active', addedDate: new Date()});
    saveData(); renderDomainList(); document.getElementById('newDomain').value = ''; safeAlert('도메인이 추가되었습니다.');
}

function renderDomainList() {
    var container = document.getElementById('domainList');
    if (!container) return;
    container.innerHTML = '';
    
    for (var i = 0; i < registeredDomains.length; i++) {
        var domain = registeredDomains[i];
        var card = document.createElement('div');
        card.className = 'card';
        var expiryText = domain.expiry ? new Date(domain.expiry).toLocaleDateString() : '무제한';
        var statusText = domain.status === 'active' ? '활성' : '비활성';
        
        card.innerHTML = '<p><strong>도메인:</strong> ' + domain.domain + '</p><p><strong>라이센스:</strong> ' + domain.type + '</p><p><strong>만료일:</strong> ' + expiryText + '</p><p><strong>상태:</strong> ' + statusText + '</p><div class="mt-10"><button class="btn btn-warning btn-sm" onclick="editDomainPrompt(\'' + domain.domain + '\')">수정</button><button class="btn btn-danger btn-sm" onclick="confirmRemoveDomain(\'' + domain.domain + '\')">삭제</button></div>';
        container.appendChild(card);
    }
}

function editDomainPrompt(domainName) {
    var domain = registeredDomains.find(function(d) { return d.domain === domainName; });
    if (!domain) return;
    
    safePrompt('라이센스 타입을 선택하세요:\n1. monthly (월간)\n2. yearly (연간)\n3. unlimited (무제한)', domain.type, function(newType) {
        if (newType && ['monthly', 'yearly', 'unlimited'].includes(newType)) {
            domain.type = newType;
            if (newType === 'monthly') { domain.expiry = new Date(); domain.expiry.setDate(domain.expiry.getDate() + 30); }
            else if (newType === 'yearly') { domain.expiry = new Date(); domain.expiry.setFullYear(domain.expiry.getFullYear() + 1); }
            else domain.expiry = null;
            saveData(); renderDomainList(); safeAlert('도메인이 수정되었습니다.');
        }
    });
}

function confirmRemoveDomain(domainName) {
    safeConfirm('정말 도메인 "' + domainName + '"을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { registeredDomains = registeredDomains.filter(function(d) { return d.domain !== domainName; }); saveData(); renderDomainList(); safeAlert('도메인이 삭제되었습니다.'); }
    });
}

// 관리자 계정 관리
function renderAdminAccountsList() {
    var container = document.getElementById('adminAccountsList');
    if (!container) return;
    container.innerHTML = '';
    
    for (var i = 0; i < adminAccounts.length; i++) {
        var admin = adminAccounts[i];
        var card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<p><strong>ID:</strong> ' + admin.id + '</p><p><strong>이름:</strong> ' + admin.name + '</p><p><strong>생성일:</strong> ' + new Date(admin.createdDate).toLocaleDateString() + '</p><div class="mt-10"><button class="btn btn-warning btn-sm" onclick="editAdminAccount(\'' + admin.id + '\')">수정</button><button class="btn btn-danger btn-sm" onclick="confirmRemoveAdminAccount(\'' + admin.id + '\')">삭제</button></div>';
        container.appendChild(card);
    }
}

function addAdminAccount() {
    var adminId = document.getElementById('newAdminId').value.trim();
    var password = document.getElementById('newAdminPassword').value.trim();
    var name = document.getElementById('newAdminName').value.trim();
    
    if (!adminId || !password || !name) { safeAlert('모든 필드를 입력해주세요.'); return; }
    if (adminAccounts.find(function(admin) { return admin.id === adminId; })) { safeAlert('이미 존재하는 관리자 ID입니다.'); return; }
    
    adminAccounts.push({id: adminId, password: password, name: name, createdDate: new Date()});
    saveData(); renderAdminAccountsList();
    document.getElementById('newAdminId').value = ''; document.getElementById('newAdminPassword').value = ''; document.getElementById('newAdminName').value = '';
    safeAlert('관리자 계정이 추가되었습니다.');
}

function editAdminAccount(adminId) {
    var admin = adminAccounts.find(function(a) { return a.id === adminId; });
    if (!admin) return;
    
    safePrompt('새 비밀번호를 입력하세요:', admin.password, function(newPassword) {
        if (newPassword) {
            safePrompt('새 이름을 입력하세요:', admin.name, function(newName) {
                if (newName) { admin.password = newPassword.trim(); admin.name = newName.trim(); saveData(); renderAdminAccountsList(); safeAlert('관리자 계정이 수정되었습니다.'); }
            });
        }
    });
}

function confirmRemoveAdminAccount(adminId) {
    if (adminId === 'admin') { safeAlert('기본 관리자 계정은 삭제할 수 없습니다.'); return; }
    safeConfirm('정말 관리자 계정 "' + adminId + '"을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { adminAccounts = adminAccounts.filter(function(admin) { return admin.id !== adminId; }); saveData(); renderAdminAccountsList(); safeAlert('관리자 계정이 삭제되었습니다.'); }
    });
}

// 재고 관리
function showAddItemModal() { document.getElementById('addItemModal').classList.remove('hidden'); }

function addItem() {
    var name = document.getElementById('itemName').value.trim();
    var color = document.getElementById('itemColor').value.trim();
    var size = document.getElementById('itemSize').value.trim();
    var cost = parseInt(document.getElementById('itemCost').value) || 0;
    var price = parseInt(document.getElementById('itemPrice').value) || 0;
    var stock = parseInt(document.getElementById('itemStock').value) || 0;
    
    if (!name || !color || !size) { safeAlert('모든 필드를 입력해주세요.'); return; }
    
    inventory.push({id: Date.now(), name: name, color: color, size: size, cost: cost, price: price, stock: stock});
    saveData(); closeModal('addItemModal'); renderInventory(); renderProducts(); safeAlert('상품이 추가되었습니다.');
}

function renderInventory() {
    var container = document.getElementById('inventoryGrid');
    if (!container) return;
    container.innerHTML = '';
    
    for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var margin = item.price > 0 ? ((item.price - item.cost) / item.price * 100).toFixed(1) : 0;
        var card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = '<h4>' + item.name + ' (' + item.color + ', ' + item.size + ')</h4><p><strong>원가:</strong> ' + item.cost.toLocaleString() + '원</p><p><strong>판매가:</strong> ' + item.price.toLocaleString() + '원</p><p><strong>마진율:</strong> ' + margin + '%</p><p><strong>재고:</strong> ' + item.stock + '개</p><div class="edit-controls"><div class="edit-field"><label>품명</label><input type="text" id="editName-' + item.id + '" value="' + item.name + '"></div><div class="edit-field"><label>컬러</label><input type="text" id="editColor-' + item.id + '" value="' + item.color + '"></div><div class="edit-field"><label>사이즈</label><input type="text" id="editSize-' + item.id + '" value="' + item.size + '"></div><div class="edit-field"><label>원가</label><input type="number" id="editCost-' + item.id + '" value="' + item.cost + '"></div><div class="edit-field"><label>판매가</label><input type="number" id="editPrice-' + item.id + '" value="' + item.price + '"></div><div class="edit-field"><label>재고</label><input type="number" id="editStock-' + item.id + '" value="' + item.stock + '"></div></div><div class="mt-10"><button class="btn btn-success btn-sm" onclick="saveItemEdit(' + item.id + ')">저장</button><button class="btn btn-danger btn-sm" onclick="confirmDeleteItem(' + item.id + ')">삭제</button></div>';
        container.appendChild(card);
    }
}

function saveItemEdit(id) {
    var item = inventory.find(function(i) { return i.id === id; });
    if (!item) return;
    
    var newName = document.getElementById('editName-' + id).value.trim();
    var newColor = document.getElementById('editColor-' + id).value.trim();
    var newSize = document.getElementById('editSize-' + id).value.trim();
    var newCost = parseInt(document.getElementById('editCost-' + id).value) || 0;
    var newPrice = parseInt(document.getElementById('editPrice-' + id).value) || 0;
    var newStock = parseInt(document.getElementById('editStock-' + id).value) || 0;
    
    if (!newName || !newColor || !newSize) { safeAlert('품명, 컬러, 사이즈는 필수입니다.'); return; }
    
    item.name = newName; item.color = newColor; item.size = newSize; item.cost = newCost; item.price = newPrice; item.stock = newStock;
    saveData(); renderInventory(); renderProducts(); safeAlert('상품 정보가 수정되었습니다.');
}

function confirmDeleteItem(id) {
    var item = inventory.find(function(i) { return i.id === id; });
    if (!item) return;
    safeConfirm('정말 상품 "' + item.name + ' (' + item.color + ', ' + item.size + ')"을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { inventory = inventory.filter(function(item) { return item.id !== id; }); saveData(); renderInventory(); renderProducts(); safeAlert('상품이 삭제되었습니다.'); }
    });
}

// 고객 관리
function showAddCustomerModal() { document.getElementById('addCustomerModal').classList.remove('hidden'); }

function addCustomer() {
    var name = document.getElementById('customerName').value.trim();
    var nickname = document.getElementById('customerNickname').value.trim();
    var phone = document.getElementById('customerPhone').value.trim();
    var address = document.getElementById('customerAddress').value.trim();
    
    if (!name || !phone) { safeAlert('이름과 연락처는 필수입니다.'); return; }
    
    customers.push({id: Date.now(), name: name, nickname: nickname || name, phone: phone, address: address});
    saveData(); closeModal('addCustomerModal'); renderCustomers(); safeAlert('고객이 추가되었습니다.');
}

function searchCustomers() { renderCustomers(document.getElementById('customerSearch').value.toLowerCase()); }

function renderCustomers(searchTerm) {
    var container = document.getElementById('customersGrid');
    if (!container) return;
    container.innerHTML = '';
    
    var filteredCustomers = customers;
    if (searchTerm) {
        filteredCustomers = customers.filter(function(customer) {
            return (customer.name || '').toLowerCase().includes(searchTerm) || (customer.nickname || '').toLowerCase().includes(searchTerm) || (customer.phone || '').toLowerCase().includes(searchTerm);
        });
    }
    
    for (var i = 0; i < filteredCustomers.length; i++) {
        var customer = filteredCustomers[i];
        var card = document.createElement('div');
        card.className = 'card';
        
        card.innerHTML = '<h4>' + customer.name + ' (' + customer.nickname + ')</h4><div class="customer-edit-controls"><div class="customer-edit-field"><label>이름:</label><input type="text" id="editCustName-' + customer.id + '" value="' + customer.name + '"></div><div class="customer-edit-field"><label>닉네임:</label><input type="text" id="editCustNick-' + customer.id + '" value="' + customer.nickname + '"></div><div class="customer-edit-field"><label>연락처:</label><input type="text" id="editCustPhone-' + customer.id + '" value="' + customer.phone + '"></div><div class="customer-edit-field"><label>주소:</label><textarea id="editCustAddress-' + customer.id + '" style="width: 100%; min-height: 60px;">' + (customer.address || '') + '</textarea></div></div><div class="mt-10"><button class="btn btn-success btn-sm" onclick="saveCustomerEdit(' + customer.id + ')">저장</button><button class="btn btn-danger btn-sm" onclick="confirmDeleteCustomer(' + customer.id + ')">삭제</button></div>';
        container.appendChild(card);
    }
}

function saveCustomerEdit(id) {
    var customer = customers.find(function(c) { return c.id === id; });
    if (!customer) return;
    
    var newName = document.getElementById('editCustName-' + id).value.trim();
    var newNickname = document.getElementById('editCustNick-' + id).value.trim();
    var newPhone = document.getElementById('editCustPhone-' + id).value.trim();
    var newAddress = document.getElementById('editCustAddress-' + id).value.trim();
    
    if (!newName || !newPhone) { safeAlert('이름과 연락처는 필수입니다.'); return; }
    
    customer.name = newName; customer.nickname = newNickname || newName; customer.phone = newPhone; customer.address = newAddress;
    saveData(); renderCustomers(); safeAlert('고객 정보가 수정되었습니다.');
}

function confirmDeleteCustomer(id) {
    var customer = customers.find(function(c) { return c.id === id; });
    if (!customer) return;
    safeConfirm('정말 고객 "' + customer.name + '"을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { customers = customers.filter(function(customer) { return customer.id !== id; }); saveData(); renderCustomers(); safeAlert('고객이 삭제되었습니다.'); }
    });
}

// 주문 관리 및 나머지 모든 함수들
function renderOrders() {
    var container = document.getElementById('ordersContainer');
    if (!container) return;
    
    var searchTerm = document.getElementById('orderSearch') ? document.getElementById('orderSearch').value.toLowerCase() : '';
    var startDate = document.getElementById('startDate') ? document.getElementById('startDate').value : '';
    var endDate = document.getElementById('endDate') ? document.getElementById('endDate').value : '';
    var customerFilter = document.getElementById('customerFilter') ? document.getElementById('customerFilter').value : '';
    var statusFilter = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : '';
    
    container.innerHTML = '';
    
    if (!orders || orders.length === 0) { container.innerHTML = '<p>주문이 없습니다.</p>'; return; }
    
    var filteredOrders = orders.filter(function(order) {
        if (!order) return false;
        
        var matchesSearch = !searchTerm || ((order.customer || '') + ' ' + (order.id || '') + ' ' + (order.items || []).map(function(item) { return item ? item.name || '' : ''; }).join(' ')).toLowerCase().includes(searchTerm);
        var matchesDateRange = true;
        if (startDate && order.orderDate) matchesDateRange = matchesDateRange && new Date(order.orderDate) >= new Date(startDate);
        if (endDate && order.orderDate) matchesDateRange = matchesDateRange && new Date(order.orderDate) <= new Date(endDate + 'T23:59:59');
        var matchesCustomer = !customerFilter || order.customer === customerFilter;
        var matchesStatus = !statusFilter || order.status === statusFilter;
        
        return matchesSearch && matchesDateRange && matchesCustomer && matchesStatus;
    });
    
    if (filteredOrders.length === 0) { container.innerHTML = '<p>검색 결과가 없습니다.</p>'; return; }
    
    var tableHtml = '<table class="table"><thead><tr><th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th><th>주문번호</th><th>주문일</th><th>고객명</th><th>받는분</th><th>연락처</th><th>배송주소</th><th>요청사항</th><th>상품</th><th>수량</th><th>금액</th><th>상태</th><th>관리</th></tr></thead><tbody>';
    
    for (var i = 0; i < filteredOrders.length; i++) {
        var order = filteredOrders[i];
        if (!order) continue;
        
        var itemsText = '', totalQty = 0;
        if (order.items && order.items.length > 0) {
            for (var j = 0; j < order.items.length; j++) {
                var item = order.items[j];
                if (item) {
                    itemsText += (item.name || '') + '(' + (item.color || '') + ',' + (item.size || '') + ')';
                    totalQty += item.quantity || 0;
                    if (j < order.items.length - 1) itemsText += '<br>';
                }
            }
        }
        
        var requestText = (order.deliveryRequest || '') + (order.customDeliveryRequest ? ' - ' + order.customDeliveryRequest : '') + (order.adminNotes ? ' [관리자메모: ' + order.adminNotes + ']' : '');
        if (requestText.length > 30) requestText = requestText.substring(0, 30) + '...';
        
        var orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString() : '미입력';
        var finalAmount = order.finalAmount || 0;
        
        tableHtml += '<tr><td><input type="checkbox" class="order-checkbox" value="' + (order.id || 0) + '" onchange="updateSelectedOrders()"></td><td>' + (order.id || '') + '</td><td>' + orderDate + '</td><td>' + (order.customer || '') + '</td><td>' + (order.receiverName || order.customer || '') + '</td><td>' + (order.receiverPhone || order.customerPhone || '') + '</td><td>' + ((order.shippingAddress || '').length > 20 ? (order.shippingAddress || '').substring(0, 20) + '...' : (order.shippingAddress || '미입력')) + '</td><td>' + requestText + '</td><td>' + itemsText + '</td><td>' + totalQty + '개</td><td>' + finalAmount.toLocaleString() + '원</td><td><select onchange="updateOrderStatus(' + (order.id || 0) + ', this.value)"><option value="입금대기"' + (order.status === '입금대기' ? ' selected' : '') + '>입금대기</option><option value="입금완료"' + (order.status === '입금완료' ? ' selected' : '') + '>입금완료</option><option value="주문확정"' + (order.status === '주문확정' ? ' selected' : '') + '>주문확정</option><option value="출고완료"' + (order.status === '출고완료' ? ' selected' : '') + '>출고완료</option></select></td><td><button class="btn btn-info btn-sm" onclick="viewOrderDetail(' + (order.id || 0) + ')">상세</button><button class="btn btn-warning btn-sm" onclick="editAdminNotes(' + (order.id || 0) + ')">메모</button><button class="btn btn-danger btn-sm" onclick="deleteOrder(' + (order.id || 0) + ')">삭제</button></td></tr>';
    }
    
    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;
    updateCustomerFilter();
}

function toggleSelectAll() {
    var selectAll = document.getElementById('selectAll');
    var checkboxes = document.querySelectorAll('.order-checkbox');
    for (var i = 0; i < checkboxes.length; i++) checkboxes[i].checked = selectAll.checked;
    updateSelectedOrders();
}

function updateSelectedOrders() {
    var checkboxes = document.querySelectorAll('.order-checkbox:checked');
    selectedOrders = [];
    for (var i = 0; i < checkboxes.length; i++) selectedOrders.push(parseInt(checkboxes[i].value));
}

function deleteSelectedOrders() {
    if (selectedOrders.length === 0) { safeAlert('삭제할 주문을 선택해주세요.'); return; }
    safeConfirm('선택한 ' + selectedOrders.length + '개의 주문을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { orders = orders.filter(function(order) { return !selectedOrders.includes(order.id); }); selectedOrders = []; saveData(); renderOrders(); safeAlert('선택한 주문이 삭제되었습니다.'); }
    });
}

function clearAllOrders() {
    safeConfirm('정말 모든 주문을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', function(confirmed) {
        if (confirmed) { orders = []; saveData(); renderOrders(); safeAlert('모든 주문이 삭제되었습니다.'); }
    });
}

function updateOrderStatus(orderId, newStatus) {
    var order = orders.find(function(o) { return o.id === orderId; });
    if (order) {
        order.status = newStatus;
        if (newStatus === '출고완료' && !order.shippingDate) order.shippingDate = new Date();
        saveData(); safeAlert('주문 상태가 업데이트되었습니다.'); renderOrders();
    }
}

function deleteOrder(orderId) {
    safeConfirm('정말 이 주문을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) { orders = orders.filter(function(o) { return o.id !== orderId; }); saveData(); renderOrders(); safeAlert('주문이 삭제되었습니다.'); }
    });
}

function editAdminNotes(orderId) {
    var order = orders.find(function(o) { return o.id === orderId; });
    if (!order) return;
    
    safePrompt('관리자 메모를 입력하세요:\n(합배 처리, 특이사항, 배송 관련 메모 등)', order.adminNotes || '', function(newNotes) {
        if (newNotes !== null) { order.adminNotes = newNotes; saveData(); renderOrders(); safeAlert('관리자 메모가 저장되었습니다.'); }
    });
}

function viewOrderDetail(orderId) {
    var order = orders.find(function(o) { return o.id === orderId; });
    if (!order) return;
    
    var detail = '=== 주문 상세 정보 ===\n\n주문번호: ' + order.id + '\n주문일: ' + new Date(order.orderDate).toLocaleDateString() + '\n\n=== 고객 정보 ===\n주문자: ' + order.customer + ' (' + order.customerPhone + ')\n받는분: ' + (order.receiverName || order.customer) + '\n연락처: ' + (order.receiverPhone || order.customerPhone) + '\n배송주소: ' + (order.shippingAddress || '미입력') + '\n';
    
    if (order.deliveryRequest) detail += '배송요청: ' + order.deliveryRequest + '\n';
    if (order.adminNotes) detail += '관리자메모: ' + order.adminNotes + '\n';
    
    detail += '\n=== 주문 상품 ===\n';
    for (var i = 0; i < order.items.length; i++) {
        var item = order.items[i];
        detail += '- ' + item.name + ' (' + item.color + ', ' + item.size + ') × ' + item.quantity + '개\n';
    }
    
    detail += '\n=== 결제 정보 ===\n상품금액: ' + order.totalAmount.toLocaleString() + '원\n배송비: ' + order.shippingFee.toLocaleString() + '원\n총 결제금액: ' + order.finalAmount.toLocaleString() + '원\n\n현재상태: ' + order.status;
    
    if (order.shippingDate) detail += '\n출고일: ' + new Date(order.shippingDate).toLocaleDateString();
    
    var modal = document.createElement('div');
    modal.className = 'custom-modal';
    var content = document.createElement('div');
    content.style.cssText = 'background: white; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;';
    content.innerHTML = '<h3>주문 상세 정보</h3><pre style="white-space: pre-wrap; font-family: inherit; margin: 15px 0;">' + detail + '</pre><div style="text-align: center; margin-top: 20px;"><button id="closeDetailBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">닫기</button></div>';
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    content.querySelector('#closeDetailBtn').onclick = function() { if (document.body.contains(modal)) document.body.removeChild(modal); };
}

function updateCustomerFilter() {
    var customerFilter = document.getElementById('customerFilter');
    if (!customerFilter) return;
    
    var uniqueCustomers = [...new Set(orders.map(function(order) { return order.customer; }))];
    customerFilter.innerHTML = '<option value="">전체 고객</option>';
    for (var i = 0; i < uniqueCustomers.length; i++) {
        var option = document.createElement('option');
        option.value = uniqueCustomers[i];
        option.textContent = uniqueCustomers[i];
        customerFilter.appendChild(option);
    }
}

function exportToExcel() {
    if (orders.length === 0) { safeAlert('내보낼 주문 데이터가 없습니다.'); return; }

    var csvContent = "주문번호,주문일,고객명,받는분,연락처,배송주소,요청사항,상품,수량,금액,상태\n";
    
    for (var i = 0; i < orders.length; i++) {
        var order = orders[i];
        var itemsText = order.items.map(function(item) { return item.name + '(' + item.color + ',' + item.size + ')'; }).join(';');
        var totalQty = order.items.reduce(function(sum, item) { return sum + item.quantity; }, 0);
        var orderDate = new Date(order.orderDate).toLocaleDateString();
        var requestText = (order.deliveryRequest || '') + (order.customDeliveryRequest ? ' - ' + order.customDeliveryRequest : '');
        
        var row = [order.id, orderDate, order.customer, order.receiverName || order.customer, order.receiverPhone || order.customerPhone, order.shippingAddress || '', requestText, itemsText, totalQty, order.finalAmount, order.status].map(function(field) { return '"' + String(field).replace(/"/g, '""') + '"'; }).join(',');
        csvContent += row + "\n";
    }
    
    var blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement("a");
    
    if (link.download !== undefined) {
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "orders_" + new Date().toISOString().split('T')[0] + ".csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        safeAlert('엑셀 파일이 다운로드되었습니다.');
    } else {
        safeAlert('브라우저에서 파일 다운로드를 지원하지 않습니다.');
    }
}

// 고객 상품 표시
function renderProducts() {
    var container = document.getElementById('productsGrid');
    if (!container) return;
    container.innerHTML = '';
    
    if (!isLive) return;
    
    for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var card = document.createElement('div');
        card.className = 'card';
        
        if (item.stock > 0) {
            // 재고가 있는 경우
            card.innerHTML = '<h4>' + item.name + '</h4><p>컬러: ' + item.color + ' | 사이즈: ' + item.size + '</p><p><strong>' + item.price.toLocaleString() + '원</strong></p><p>재고: ' + item.stock + '개</p><div class="quantity-control mt-10"><button class="quantity-btn" onclick="changeQuantity(' + item.id + ', -1)">-</button><span id="qty-' + item.id + '">1</span><button class="quantity-btn" onclick="changeQuantity(' + item.id + ', 1)">+</button></div><button class="btn btn-primary mt-10" onclick="addToCart(' + item.id + ')">장바구니 담기</button>';
        } else {
            // 품절인 경우
            card.innerHTML = '<h4>' + item.name + '</h4><p>컬러: ' + item.color + ' | 사이즈: ' + item.size + '</p><p><strong>' + item.price.toLocaleString() + '원</strong></p><p style="color: #dc3545; font-weight: bold;">품절</p><div class="quantity-control mt-10"><button class="quantity-btn" disabled style="opacity: 0.5; cursor: not-allowed;">-</button><span style="opacity: 0.5;">1</span><button class="quantity-btn" disabled style="opacity: 0.5; cursor: not-allowed;">+</button></div><button class="btn mt-10" disabled style="background: #6c757d; color: white; cursor: not-allowed; opacity: 0.6;">품절</button>';
            card.style.opacity = '0.7';
        }
        
        container.appendChild(card);
    }
}

function changeQuantity(itemId, change) {
    var qtyElement = document.getElementById('qty-' + itemId);
    if (!qtyElement) return;
    
    var currentQty = parseInt(qtyElement.textContent);
    var newQty = Math.max(1, currentQty + change);
    var item = inventory.find(function(i) { return i.id === itemId; });
    
    if (item && newQty <= item.stock) qtyElement.textContent = newQty;
}

function addToCart(itemId) {
    var item = inventory.find(function(i) { return i.id === itemId; });
    var qtyElement = document.getElementById('qty-' + itemId);
    if (!qtyElement) return;
    
    var quantity = parseInt(qtyElement.textContent);
    
    if (!item || quantity > item.stock) { safeAlert('재고가 부족합니다.'); return; }
    
    item.stock -= quantity;
    
    var cartItem = cart.find(function(c) { return c.id === itemId; });
    if (cartItem) cartItem.quantity += quantity;
    else cart.push({id: itemId, name: item.name, color: item.color, size: item.size, price: item.price, quantity: quantity});
    
    startCartTimer(); renderProducts(); renderCart(); saveData(); safeAlert('장바구니에 담았습니다.');
}

function startCartTimer() {
    clearTimeout(cartTimer);
    var timeLeft = 300;
    
    var timerEl = document.getElementById('cartTimer');
    if (timerEl) timerEl.classList.remove('hidden');
    
    function updateTimer() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        var displayEl = document.getElementById('timerDisplay');
        if (displayEl) displayEl.textContent = minutes + '분 ' + (seconds < 10 ? '0' : '') + seconds + '초';
        
        if (timeLeft <= 0) { clearCart(); safeAlert('장바구니 시간이 만료되어 상품이 재고로 돌아갔습니다.'); }
        else { timeLeft--; cartTimer = setTimeout(updateTimer, 1000); }
    }
    
    updateTimer();
}

function clearCart() {
    for (var i = 0; i < cart.length; i++) {
        var cartItem = cart[i];
        var inventoryItem = inventory.find(function(item) { return item.id === cartItem.id; });
        if (inventoryItem) inventoryItem.stock += cartItem.quantity;
    }
    
    cart = []; clearTimeout(cartTimer);
    var timerEl = document.getElementById('cartTimer');
    if (timerEl) timerEl.classList.add('hidden');
    renderCart(); renderProducts(); saveData();
}

function confirmPurchase() {
    if (cart.length === 0) return;
    
    var totalAmount = cart.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
    var shippingFee = totalAmount >= shippingSettings.freeThreshold ? 0 : shippingSettings.baseShipping;
    var finalAmount = totalAmount + shippingFee;
    
    confirmedOrder = {items: cart.slice(), totalAmount: totalAmount, shippingFee: shippingFee, finalAmount: finalAmount, receiverName: currentUser.name, receiverPhone: currentUser.phone, shippingAddress: '', deliveryRequest: ''};
    
    cart = []; clearTimeout(cartTimer);
    var timerEl = document.getElementById('cartTimer');
    if (timerEl) timerEl.classList.add('hidden');
    
    showCustomerTab('confirmed'); renderConfirmedOrder(); renderCart(); safeAlert('구매가 확정되었습니다. 배송 정보를 입력해주세요.');
}

function toggleMergeField() {
    var deliveryRequest = document.getElementById('deliveryRequest');
    var mergePartnerName = document.getElementById('mergePartnerName');
    var customDeliveryRequest = document.getElementById('customDeliveryRequest');
    
    if (deliveryRequest.value === '합배포망') { mergePartnerName.style.display = 'block'; customDeliveryRequest.style.display = 'none'; }
    else if (deliveryRequest.value === '기타') { mergePartnerName.style.display = 'none'; customDeliveryRequest.style.display = 'block'; }
    else { mergePartnerName.style.display = 'none'; customDeliveryRequest.style.display = 'none'; }
}

function renderConfirmedOrder() {
    var container = document.getElementById('confirmedItems');
    var itemsList = document.getElementById('confirmedItemsList');
    if (!container) return;
    
    if (!confirmedOrder) {
        container.innerHTML = '<p>구매 확정된 주문이 없습니다.</p>';
        if (itemsList) itemsList.innerHTML = '';
        
        var elements = ['receiverName', 'receiverPhone', 'shippingAddress', 'deliveryRequest', 'customDeliveryRequest', 'mergePartnerName'];
        elements.forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; });
        
        var amounts = ['confirmedTotalAmount', 'confirmedShippingFee', 'confirmedFinalAmount'];
        amounts.forEach(function(id) { var el = document.getElementById(id); if (el) el.textContent = '0'; });
        return;
    }
    
    container.innerHTML = '<h4>주문 상품</h4>';
    
    for (var i = 0; i < confirmedOrder.items.length; i++) {
        var item = confirmedOrder.items[i];
        var itemTotal = item.price * item.quantity;
        var itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = '<div><h5>' + item.name + ' (' + item.color + ', ' + item.size + ')</h5><p>' + item.price.toLocaleString() + '원 × ' + item.quantity + '개 = ' + itemTotal.toLocaleString() + '원</p></div>';
        container.appendChild(itemDiv);
    }
    
    if (itemsList) {
        itemsList.innerHTML = '<h5>개별 상품 수정</h5>';
        for (var i = 0; i < confirmedOrder.items.length; i++) {
            var item = confirmedOrder.items[i];
            var itemDiv = document.createElement('div');
            itemDiv.className = 'confirmed-item';
            itemDiv.innerHTML = '<div><span>' + item.name + ' (' + item.color + ', ' + item.size + ') × ' + item.quantity + '개</span></div><div><button class="btn btn-warning btn-sm" onclick="editConfirmedItem(' + item.id + ')">수정</button><button class="btn btn-danger btn-sm" onclick="removeConfirmedItem(' + item.id + ')">삭제</button></div>';
            itemsList.appendChild(itemDiv);
        }
    }
    
    var fields = [
        {id: 'receiverName', prop: 'receiverName'},
        {id: 'receiverPhone', prop: 'receiverPhone'},
        {id: 'shippingAddress', prop: 'shippingAddress'},
        {id: 'deliveryRequest', prop: 'deliveryRequest'},
        {id: 'customDeliveryRequest', prop: 'customDeliveryRequest'},
        {id: 'mergePartnerName', prop: 'mergePartnerName'}
    ];
    
    fields.forEach(function(field) {
        var el = document.getElementById(field.id);
        if (el) el.value = confirmedOrder[field.prop] || '';
    });
    
    updateConfirmedOrderSummary();
}

function updateConfirmedOrderSummary() {
    if (!confirmedOrder) return;
    
    var totalAmount = confirmedOrder.items.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
    var shippingFee = totalAmount >= shippingSettings.freeThreshold ? 0 : shippingSettings.baseShipping;
    var finalAmount = totalAmount + shippingFee;
    
    confirmedOrder.totalAmount = totalAmount; confirmedOrder.shippingFee = shippingFee; confirmedOrder.finalAmount = finalAmount;
    
    var amounts = [
        {id: 'confirmedTotalAmount', value: totalAmount},
        {id: 'confirmedShippingFee', value: shippingFee},
        {id: 'confirmedFinalAmount', value: finalAmount}
    ];
    
    amounts.forEach(function(amount) {
        var el = document.getElementById(amount.id);
        if (el) el.textContent = amount.value.toLocaleString();
    });
}

function editConfirmedItem(itemId) {
    if (!confirmedOrder || !isLive) { safeAlert('라이브가 종료되어 수정할 수 없습니다.'); return; }
    
    var item = confirmedOrder.items.find(function(i) { return i.id === itemId; });
    if (!item) { safeAlert('해당 상품을 찾을 수 없습니다.'); return; }
    
    safePrompt('수량을 입력하세요 (현재: ' + item.quantity + '개):', item.quantity.toString(), function(newQuantityStr) {
        if (newQuantityStr === null) return;
        
        var newQuantity = parseInt(newQuantityStr);
        if (isNaN(newQuantity) || newQuantity <= 0) { safeAlert('올바른 수량을 입력해주세요.'); return; }
        
        var inventoryItem = inventory.find(function(i) { return i.id === itemId; });
        if (!inventoryItem) { safeAlert('해당 상품을 찾을 수 없습니다.'); return; }
        
        var stockChange = newQuantity - item.quantity;
        if (stockChange > inventoryItem.stock) { safeAlert('재고가 부족합니다. (현재 재고: ' + inventoryItem.stock + '개)'); return; }
        
        inventoryItem.stock -= stockChange; item.quantity = newQuantity;
        saveData(); renderConfirmedOrder(); renderProducts(); safeAlert('상품 수량이 수정되었습니다.');
    });
}

function removeConfirmedItem(itemId) {
    if (!confirmedOrder || !isLive) { safeAlert('라이브가 종료되어 수정할 수 없습니다.'); return; }
    
    var item = confirmedOrder.items.find(function(i) { return i.id === itemId; });
    if (!item) { safeAlert('해당 상품을 찾을 수 없습니다.'); return; }
    
    safeConfirm('상품 "' + item.name + ' (' + item.color + ', ' + item.size + ')"을 주문에서 제거하시겠습니까?', function(confirmed) {
        if (!confirmed) return;
        
        var inventoryItem = inventory.find(function(i) { return i.id === itemId; });
        if (inventoryItem) inventoryItem.stock += item.quantity;
        
        confirmedOrder.items = confirmedOrder.items.filter(function(i) { return i.id !== itemId; });
        
        if (confirmedOrder.items.length === 0) { confirmedOrder = null; safeAlert('모든 상품이 제거되어 주문이 취소되었습니다.'); }
        else safeAlert('상품이 주문에서 제거되었습니다.');
        
        saveData(); renderConfirmedOrder(); renderProducts();
    });
}

function returnToCart() {
    if (!confirmedOrder) { safeAlert('구매 확정된 주문이 없습니다.'); return; }
    if (!isLive) { safeAlert('라이브가 종료되어 주문을 수정할 수 없습니다.'); return; }
    
    safeConfirm('주문을 장바구니로 되돌리시겠습니까?\n\n- 현재 주문이 취소됩니다\n- 상품이 장바구니로 돌아갑니다\n- 5분 타이머가 다시 시작됩니다', function(confirmed) {
        if (!confirmed) return;
        
        for (var i = 0; i < confirmedOrder.items.length; i++) {
            var orderItem = confirmedOrder.items[i];
            var inventoryItem = inventory.find(function(item) { return item.id === orderItem.id; });
            if (inventoryItem) inventoryItem.stock += orderItem.quantity;
        }
        
        cart = confirmedOrder.items.slice(); confirmedOrder = null;
        showCustomerTab('cart', null);
        startCartTimer(); renderCart(); renderProducts(); renderConfirmedOrder();
        safeAlert('주문이 장바구니로 돌아갔습니다. 5분 내에 다시 구매 확정해주세요.');
    });
}

function renderCart() {
    var container = document.getElementById('cartItems');
    var summary = document.getElementById('cartSummary');
    
    if (!container || !summary) return;
    
    container.innerHTML = '';
    
    if (cart.length === 0) { container.innerHTML = '<p>장바구니가 비어있습니다.</p>'; summary.classList.add('hidden'); return; }
    
    var totalAmount = 0;
    
    for (var i = 0; i < cart.length; i++) {
        var item = cart[i];
        var itemTotal = item.price * item.quantity;
        totalAmount += itemTotal;
        
        var cartDiv = document.createElement('div');
        cartDiv.className = 'cart-item';
        cartDiv.innerHTML = '<div><h5>' + item.name + ' (' + item.color + ', ' + item.size + ')</h5><p>' + item.price.toLocaleString() + '원 × ' + item.quantity + '개 = ' + itemTotal.toLocaleString() + '원</p><div class="quantity-control mt-10"><button class="quantity-btn" onclick="updateCartQuantity(' + item.id + ', -1)">-</button><span style="margin: 0 10px;">' + item.quantity + '</span><button class="quantity-btn" onclick="updateCartQuantity(' + item.id + ', 1)">+</button></div></div><button class="btn btn-danger btn-sm" onclick="removeFromCart(' + item.id + ')">삭제</button>';
        container.appendChild(cartDiv);
    }
    
    var shippingFee = totalAmount >= shippingSettings.freeThreshold ? 0 : shippingSettings.baseShipping;
    var finalAmount = totalAmount + shippingFee;
    
    var elements = [
        {id: 'totalAmount', value: totalAmount},
        {id: 'shippingFee', value: shippingFee},
        {id: 'finalAmount', value: finalAmount}
    ];
    
    elements.forEach(function(element) {
        var el = document.getElementById(element.id);
        if (el) el.textContent = element.value.toLocaleString();
    });
    
    summary.classList.remove('hidden');
}

function updateCartQuantity(itemId, change) {
    var cartItem = cart.find(function(c) { return c.id === itemId; });
    var inventoryItem = inventory.find(function(i) { return i.id === itemId; });
    
    if (!cartItem || !inventoryItem) return;
    
    var newQuantity = cartItem.quantity + change;
    
    if (newQuantity <= 0) { removeFromCart(itemId); return; }
    
    if (change > 0) {
        if (inventoryItem.stock < change) { safeAlert('재고가 부족합니다. (남은 재고: ' + inventoryItem.stock + '개)'); return; }
        inventoryItem.stock -= change;
    } else {
        inventoryItem.stock += Math.abs(change);
    }
    
    cartItem.quantity = newQuantity;
    renderCart(); renderProducts(); saveData();
}

function removeFromCart(itemId) {
    var cartItem = cart.find(function(c) { return c.id === itemId; });
    if (cartItem) {
        var inventoryItem = inventory.find(function(item) { return item.id === itemId; });
        if (inventoryItem) inventoryItem.stock += cartItem.quantity;
        cart = cart.filter(function(c) { return c.id !== itemId; });
        renderCart(); renderProducts(); saveData();
    }
}

function proceedToPayment() {
    if (!confirmedOrder) { safeAlert('구매 확정된 주문이 없습니다.'); return; }
    
    var fields = ['receiverName', 'receiverPhone', 'shippingAddress', 'deliveryRequest', 'customDeliveryRequest', 'mergePartnerName'];
    fields.forEach(function(fieldId) {
        var el = document.getElementById(fieldId);
        if (el) confirmedOrder[fieldId] = el.value.trim();
    });
    
    if (!confirmedOrder.receiverName || !confirmedOrder.receiverPhone || !confirmedOrder.shippingAddress) { safeAlert('받는 분 이름, 연락처, 배송 주소는 필수입니다.'); return; }
    
    var finalDeliveryRequest = confirmedOrder.deliveryRequest;
    if (confirmedOrder.deliveryRequest === '합배포망' && confirmedOrder.mergePartnerName) finalDeliveryRequest += ' - ' + confirmedOrder.mergePartnerName;
    else if (confirmedOrder.deliveryRequest === '기타' && confirmedOrder.customDeliveryRequest) finalDeliveryRequest = confirmedOrder.customDeliveryRequest;
    
    var paymentInfo = '<h4>입금 안내</h4><p><strong>은행:</strong> ' + bankInfo.bankName + '</p><p><strong>계좌번호:</strong> ' + bankInfo.accountNumber + '</p><p><strong>예금주:</strong> ' + bankInfo.accountHolder + '</p><p><strong>입금금액:</strong> ' + confirmedOrder.finalAmount.toLocaleString() + '원</p><hr><h5>주문 정보</h5><p><strong>받는 분:</strong> ' + confirmedOrder.receiverName + '</p><p><strong>연락처:</strong> ' + confirmedOrder.receiverPhone + '</p><p><strong>배송 주소:</strong> ' + confirmedOrder.shippingAddress + '</p>' + (finalDeliveryRequest ? '<p><strong>요청사항:</strong> ' + finalDeliveryRequest + '</p>' : '') + '<div class="alert alert-warning mt-10"><pre>' + bankInfo.notice + '</pre></div>';
    
    var paymentInfoEl = document.getElementById('paymentInfo');
    if (paymentInfoEl) paymentInfoEl.innerHTML = paymentInfo;
    
    var paymentModal = document.getElementById('paymentModal');
    if (paymentModal) paymentModal.classList.remove('hidden');
}

function confirmPayment() {
    if (!confirmedOrder) return;
    
    var finalDeliveryRequest = confirmedOrder.deliveryRequest;
    if (confirmedOrder.deliveryRequest === '합배포망' && confirmedOrder.mergePartnerName) finalDeliveryRequest += ' - ' + confirmedOrder.mergePartnerName;
    else if (confirmedOrder.deliveryRequest === '기타' && confirmedOrder.customDeliveryRequest) finalDeliveryRequest = confirmedOrder.customDeliveryRequest;
    
    var order = {
        id: Date.now(), customer: currentUser.name, customerPhone: currentUser.phone,
        receiverName: confirmedOrder.receiverName, receiverPhone: confirmedOrder.receiverPhone,
        shippingAddress: confirmedOrder.shippingAddress, deliveryRequest: finalDeliveryRequest,
        customDeliveryRequest: confirmedOrder.customDeliveryRequest || '',
        mergePartnerName: confirmedOrder.mergePartnerName || '',
        items: confirmedOrder.items.slice(), totalAmount: confirmedOrder.totalAmount,
        shippingFee: confirmedOrder.shippingFee, finalAmount: confirmedOrder.finalAmount,
        status: '입금대기', orderDate: new Date(), shippingDate: null
    };
    
    orders.push(order);
    
    // 고객을 주소록에 자동 추가
    var existingCustomer = customers.find(function(c) { 
        return c.name === currentUser.name && c.phone === currentUser.phone; 
    });
    
    if (!existingCustomer) {
        customers.push({
            id: Date.now(),
            name: currentUser.name,
            nickname: currentUser.name,
            phone: currentUser.phone,
            address: confirmedOrder.shippingAddress
        });
    } else {
        // 기존 고객의 주소 정보 업데이트
        if (!existingCustomer.address || existingCustomer.address !== confirmedOrder.shippingAddress) {
            existingCustomer.address = confirmedOrder.shippingAddress;
        }
    }
    
    confirmedOrder = null;
    saveData(); closeModal('paymentModal'); renderConfirmedOrder(); renderCustomerOrders();
    showCustomerTab('myOrders'); safeAlert('주문이 완료되었습니다. 입금 후 입금완료 버튼을 눌러주세요.');
}

function renderCustomerOrders() {
    var container = document.getElementById('customerOrdersContainer');
    if (!container || !currentUser) return;
    
    container.innerHTML = '';
    
    var customerOrders = orders.filter(function(order) { return order.customer === currentUser.name; });
    
    if (customerOrders.length === 0) { container.innerHTML = '<p>주문 내역이 없습니다.</p>'; return; }
    
    for (var i = 0; i < customerOrders.length; i++) {
        var order = customerOrders[i];
        var card = document.createElement('div');
        card.className = 'card';
        
        var itemsHtml = '';
        for (var j = 0; j < order.items.length; j++) {
            var item = order.items[j];
            itemsHtml += '<li>' + item.name + ' (' + item.color + ', ' + item.size + ') × ' + item.quantity + '개</li>';
        }
        
        var statusClass = 'status-pending';
        if (order.status === '입금완료') statusClass = 'status-paid';
        if (order.status === '주문확정') statusClass = 'status-confirmed';
        if (order.status === '출고완료') statusClass = 'status-shipped';
        
        var paymentButton = '';
        if (order.status === '입금대기') paymentButton = '<button class="btn btn-success mt-10" onclick="markPaymentComplete(' + order.id + ')">입금완료</button>';
        
        card.innerHTML = '<h4>주문번호: ' + order.id + '</h4><p>주문일: ' + new Date(order.orderDate).toLocaleDateString() + '</p><p>상태: <span class="' + statusClass + '">' + order.status + '</span></p><hr><p><strong>받는 분:</strong> ' + (order.receiverName || order.customer) + '</p><p><strong>연락처:</strong> ' + (order.receiverPhone || order.customerPhone) + '</p><p><strong>배송 주소:</strong> ' + (order.shippingAddress || '미입력') + '</p>' + (order.deliveryRequest ? '<p><strong>요청사항:</strong> ' + order.deliveryRequest + '</p>' : '') + '<hr><p><strong>주문 상품:</strong></p><ul>' + itemsHtml + '</ul><p><strong>상품금액:</strong> ' + order.totalAmount.toLocaleString() + '원</p><p><strong>배송비:</strong> ' + order.shippingFee.toLocaleString() + '원</p><h4><strong>총 결제금액: ' + order.finalAmount.toLocaleString() + '원</strong></h4>' + paymentButton;
        
        container.appendChild(card);
    }
}

function deleteCustomerAllOrders() {
    var customerFilter = document.getElementById('customerFilter');
    if (!customerFilter || !customerFilter.value) {
        safeAlert('먼저 고객을 선택해주세요.');
        return;
    }
    
    var selectedCustomer = customerFilter.value;
    var customerOrders = orders.filter(function(order) { return order.customer === selectedCustomer; });
    
    if (customerOrders.length === 0) {
        safeAlert('해당 고객의 주문이 없습니다.');
        return;
    }
    
    safeConfirm('고객 "' + selectedCustomer + '"의 모든 주문 ' + customerOrders.length + '건을 삭제하시겠습니까?', function(confirmed) {
        if (confirmed) {
            orders = orders.filter(function(order) { return order.customer !== selectedCustomer; });
            saveData();
            renderOrders();
            safeAlert('고객 "' + selectedCustomer + '"의 모든 주문이 삭제되었습니다.');
        }
    });
}

function markPaymentComplete(orderId) {
    var order = orders.find(function(o) { return o.id === orderId; });
    if (!order) return;
    
    order.status = '입금완료';
    saveData(); renderCustomerOrders(); safeAlert('입금 완료 처리되었습니다. 관리자가 확인 후 주문이 확정됩니다.');
}

function saveShippingSettings() {
    var baseShippingEl = document.getElementById('baseShipping');
    var freeThresholdEl = document.getElementById('freeShippingThreshold');
    
    if (baseShippingEl) shippingSettings.baseShipping = parseInt(baseShippingEl.value) || 0;
    if (freeThresholdEl) shippingSettings.freeThreshold = parseInt(freeThresholdEl.value) || 0;
    
    saveData(); safeAlert('배송비 설정이 저장되었습니다.');
}

function saveBankInfo() {
    var elements = ['bankName', 'accountNumber', 'accountHolder', 'bankNotice'];
    elements.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            if (id === 'bankNotice') bankInfo.notice = el.value;
            else if (id === 'bankName') bankInfo.bankName = el.value;
            else if (id === 'accountNumber') bankInfo.accountNumber = el.value;
            else if (id === 'accountHolder') bankInfo.accountHolder = el.value;
        }
    });
    
    saveData(); safeAlert('입금 정보가 저장되었습니다.');
}

function closeModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) modal.classList.add('hidden');
    
    if (modalId === 'addItemModal') {
        var fields = ['itemName', 'itemColor', 'itemSize', 'itemCost', 'itemPrice', 'itemStock'];
        fields.forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; });
    }
    if (modalId === 'addCustomerModal') {
        var fields = ['customerName', 'customerNickname', 'customerPhone', 'customerAddress'];
        fields.forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; });
    }
}

// 초기화
window.onload = function() {
    loadData(); updateLiveStatus(); updateFirebaseStatus('disconnected'); updateSyncStatus('offline');
    
    // Firebase 설정 자동 로드
    loadFirebaseConfig();
    
    var shippingElements = [
        {id: 'baseShipping', value: shippingSettings.baseShipping},
        {id: 'freeShippingThreshold', value: shippingSettings.freeThreshold}
    ];
    
    var bankElements = [
        {id: 'bankName', value: bankInfo.bankName},
        {id: 'accountNumber', value: bankInfo.accountNumber},
        {id: 'accountHolder', value: bankInfo.accountHolder},
        {id: 'bankNotice', value: bankInfo.notice}
    ];
    
    shippingElements.concat(bankElements).forEach(function(element) {
        var el = document.getElementById(element.id);
        if (el) el.value = element.value;
    });
    
    renderDomainList();
};
</script>
</body>
</html>